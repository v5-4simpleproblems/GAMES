<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StrongDog XP</title>
    <link rel="stylesheet" href="assets/styles.css" />

    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1609993827735056"
      crossorigin="anonymous"
    ></script>

    <script>
      const polytrackKeys = [];
      const babelTowerKeys = [];
      const idleSharkKey = ["sharkGameSave"];
      const cookieClickerKey = ["CookieClickerGame"];
      const badEggKeys = [];

      function getParsedItem(key) {
        const item = localStorage.getItem(key);
        try {
          return JSON.parse(item);
        } catch (err) {
          console.warn(`Invalid JSON for key '${key}': ${err}`);
          return item;
        }
      }
      function copyText(text) {
        navigator.clipboard.writeText(text).then(
          () => showTransferInstructions(),
          (err) => alert(`Error copying data: ${err}`)
        );
      }
      function showTransferInstructions() {
        alert(
          "Your save data was copied to clipboard!\n" +
            "Paste it into the new site’s import.\n\n" +
            "DON'T overwrite your clipboard before you import!"
        );
      }
      function setDataInObject(dataObj) {
        Object.entries(dataObj).forEach(([k, v]) => {
          if (v !== null) {
            const strVal = typeof v === "string" ? v : JSON.stringify(v);
            localStorage.setItem(k, strVal);
          }
        });
      }
      function validateData(dataObj) {
        return Object.values(dataObj).every((val) => val !== null);
      }
      function getAndBundleDataIntoObj(keysArr) {
        const dataObj = Object.fromEntries(keysArr.map((k) => [k, getParsedItem(k)]));
        if (!validateData(dataObj)) {
          alert(
            "Some keys could not be retrieved. If unexpected, check localStorage or contact support."
          );
        }
        return JSON.stringify(dataObj);
      }
      function getDataAndCopy(keysArr) {
        const str = getAndBundleDataIntoObj(keysArr);
        if (str) copyText(str);
      }

      document.addEventListener("DOMContentLoaded", function () {
        if (window.location.hostname.includes("netlify.app")) {
          document.body.innerHTML = `
            <div style="padding:20px; text-align:center; color:white; background-color:#333;">
              <p>You're on Netlify. We moved to GitHub!</p>
              <p>Use these buttons to copy your data etc...</p>
            </div>
          `;
          document.body.style = "height:100vh; margin:0; display:grid; place-items:center;";
        } else {
          const importBtn = document.getElementById("import-save-data-btn");
          if (importBtn) {
            importBtn.addEventListener("click", () => {
              if (!confirm("Overwrite your local saves? If unsure, press CANCEL.")) return;
              navigator.clipboard
                .readText()
                .then((txt) => {
                  if (!txt) throw new Error("Clipboard is empty!");
                  let parsed;
                  try {
                    parsed = JSON.parse(txt);
                  } catch (e) {
                    throw new Error("Clipboard not valid JSON.");
                  }
                  if (typeof parsed !== "object") throw new Error("Invalid data in clipboard.");
                  setDataInObject(parsed);
                  alert("Data imported successfully!");
                })
                .catch((err) => alert(`Failed to read clipboard: ${err}`));
            });
          }
        }
      });
    </script>

    <script>
      window.siteMapping = {
        "strongdogxp.github.io": [
          "https://strongdogxp.github.io/strongdog2",
          "https://strongdogxp.github.io/strongdog3",
        ],
        "mathcordxp.github.io": [],
      };
    </script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBh-VnGiP4qZD0r14gfn9dr77GwtslpTqU",
        authDomain: "strongdog-auth.firebaseapp.com",
        projectId: "strongdog-auth",
        storageBucket: "strongdog-auth.appspot.com",
        messagingSenderId: "936276282572",
        appId: "1:936276282572:web:a802b7f609381ff9428669",
        measurementId: "G-0YLTCV2MMS",
      };
      firebase.initializeApp(firebaseConfig);
      window.auth = firebase.auth();
      window.db = firebase.firestore();
      window.rtdb = firebase.database();
    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-D88TDDVPGJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-D88TDDVPGJ");
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        if (!document.getElementById("autoSaveModal")) {
          const modal = document.createElement("div");
          modal.id = "autoSaveModal";
          modal.style.cssText =
            "display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; z-index:3000;";
          modal.innerHTML = `
            <div style="background:#333; padding:20px; border-radius:5px; text-align:center; color:#fff; max-width:90%;">
              <p>Would you like to load your auto-save?<br>If not now, you'll have to enable it manually later.</p>
              <button id="autoSaveYes" style="margin-right:10px; padding:10px 20px; background:orange; border:none; border-radius:5px;cursor:pointer;">Yes</button>
              <button id="autoSaveNo" style="padding:10px 20px; background:gray; border:none; border-radius:5px;cursor:pointer;">No</button>
            </div>
          `;
          document.body.appendChild(modal);
        }

        function setCookie(name, value, days) {
          const d = new Date();
          d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
          document.cookie = `${name}=${value};expires=${d.toUTCString()};path=/`;
        }
        function getCookie(name) {
          const all = `; ${document.cookie}`;
          const parts = all.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(";")[0];
          return "";
        }

        function getAllLocalStorageData() {
          const data = {};
          for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            data[k] = localStorage.getItem(k);
          }
          return data;
        }
        function setAllLocalStorageData(obj) {
          localStorage.clear();
          for (const k in obj) {
            localStorage.setItem(k, obj[k]);
          }
        }

        function autoSaveData() {
          if (!window.currentUserId) return;
          const data = getAllLocalStorageData();
          const docRef = window.db
            .collection("users")
            .doc(window.currentUserId)
            .collection("saves")
            .doc("slot3");
          docRef
            .set({
              title: "Auto Save",
              description: "Auto-saved on " + new Date().toLocaleString(),
              localStorageData: data,
            })
            .catch((err) => console.error("Auto-save error:", err));
        }
        function loadAutoSave() {
          if (!window.currentUserId) return;
          const docRef = window.db
            .collection("users")
            .doc(window.currentUserId)
            .collection("saves")
            .doc("slot3");
          docRef.get().then((docSnap) => {
            if (docSnap.exists && docSnap.data().localStorageData) {
              setAllLocalStorageData(docSnap.data().localStorageData);
              alert("Auto-save loaded!");
            } else {
              alert("No auto-save data found in Firestore.");
            }
          });
        }

        function showAutoSaveModal() {
          document.getElementById("autoSaveModal").style.display = "flex";
        }
        function hideAutoSaveModal() {
          document.getElementById("autoSaveModal").style.display = "none";
        }

        const yesBtn = document.getElementById("autoSaveYes");
        const noBtn = document.getElementById("autoSaveNo");
        yesBtn?.addEventListener("click", () => {
          hideAutoSaveModal();
          setCookie("autoSaveEnabled", "true", 9999);
          loadAutoSave();
        });
        noBtn?.addEventListener("click", () => {
          hideAutoSaveModal();
          setCookie("autoSaveEnabled", "false", 9999);
        });

        window.auth.onAuthStateChanged(async (user) => {
          if (user) {
            window.currentUserId = user.uid;
            const autoEnabled = getCookie("autoSaveEnabled");
            if (!autoEnabled) {
              const docRef = window.db
                .collection("users")
                .doc(user.uid)
                .collection("saves")
                .doc("slot3");
              const docSnap = await docRef.get();
              if (docSnap.exists && docSnap.data().localStorageData) {
                showAutoSaveModal();
              } else {
                setCookie("autoSaveEnabled", "true", 9999);
                if (!getCookie("autoSaveDone")) {
                  autoSaveData();
                  setCookie("autoSaveDone", "true", 1);
                }
              }
            } else if (autoEnabled === "true" && !getCookie("autoSaveDone")) {
              autoSaveData();
              setCookie("autoSaveDone", "true", 1);
            }
          }
        });
      });
    </script>
  </head>

  <body>
    <div
      id="secretLink"
      title="Secret Menu"
      style="
        position:absolute; top:10px; right:10px; width:10px; height:10px;
        cursor:pointer; border-radius:50%; display:flex; align-items:center;
        justify-content:center; z-index:1000;
      "
    ></div>
    <script>
      window.addEventListener("load", function () {
        const secretLink = document.getElementById("secretLink");
        secretLink.addEventListener("click", function () {
          window.location.href = "secret-menu.html";
        });
      });
    </script>

    <div class="navbar">
      <div class="menu-icon" id="menuIcon">☰</div>
      <a href="index.html" class="logo">StrongDog<span class="xp">XP</span></a>

      <div class="search-container">
        <input
          type="text"
          class="search-bar"
          placeholder="Search for games..."
          id="searchInput"
          autocomplete="off"
        />
        <div class="search-results" id="searchResults"></div>
      </div>
    </div>

    <div class="updates-text-container">
      <p class="updates-paragraph-text">Dont forget to join the discord!</p>
    </div>

    <div class="modal" id="popupModal">
      <div class="modal-content">
        <span class="modal-close" id="closeModal">×</span>
        <p>
          The StrongDog Discord server is a place for StrongDog users to chill,
          request ideas, and have fun!
          <a href="https://discord.gg/pWjfQ4Sz5c" target="_blank">Join here</a>.
        </p>
      </div>
    </div>

    <h2 id="topGameHeader" style="text-align:center"><strong>Top 20</strong></h2>
    <div class="games-grid" id="topGameList"></div>

    <div class="section-header" id="favoritesHeader" style="display:none">
      <h2 style="text-align:center"><strong>Favorites</strong></h2>
    </div>
    <div class="games-grid" id="favoritesGameList" style="display:none"></div>

    <div class="section-header">
      <h2 style="text-align:center"><strong>All</strong></h2>
      <span class="edit-button" id="editAllButton">✏️</span>
    </div>
    <div class="games-grid" id="allGameList"></div>

    <h2 style="text-align:center"><strong>StrongDogXP LLC</strong></h2>
    <div class="news-container">
      <div class="news">
        <div class="credits-item">
          <div class="credits-role">CEO</div>
          <div class="credits-names">
            <a
              href="https://github.com/jman1593"
              target="_blank"
              class="credits-link"
              >Joshua Pettit</a
            >
          </div>
        </div>
        <div class="credits-item">
          <div class="credits-role">Developers</div>
          <div class="credits-names">
            <a
              href="https://github.com/JamesMeadows4"
              target="_blank"
              class="credits-link"
              >James Meadows</a
            >
            <span>|</span>
            <a
              href="https://github.com/jman1593"
              target="_blank"
              class="credits-link"
              >Joshua Pettit</a
            >
            <span>|</span>
            <a
              href="https://playfab-pal.co.uk/"
              target="_blank"
              class="credits-link"
              >Aaron B</a
            >
          </div>
        </div>
        <div class="credits-item">
          <div class="credits-role">Game Downloaders</div>
          <div class="credits-names">
            <a
              href="https://github.com/jman1593"
              target="_blank"
              class="credits-link"
              >Joshua Pettit</a
            >
            <span>|</span>
            <a
              href="https://maxwellstevenson.com"
              target="_blank"
              class="credits-link"
              >Maxwell Stevenson</a
            >
          </div>
        </div>
      </div>
    </div>

    <h2 class="alternate-links-title">Alternate Links</h2>
    <div class="alternate-links-container" id="alternate-links-container"></div>
    <div class="alternate-links-key" id="alternate-links-key"></div>
    <h2 class="alternate-links-title">
      Exclusive links available on the StrongDogXP
      <a href="https://discord.gg/pWjfQ4Sz5c">Discord server</a>!
    </h2>

    <div class="slide-menu" id="slideMenu" style="transform:translateX(-100%)">
      <div class="categories">
        <a href="favs.html" class="option-link">Favorites</a>
        <a href="#" id="randomGame" class="option-link">Random Game</a>
        <a href="#" id="blockLanschool" class="option-link">Block Lanschool</a>
        <a href="about.html" class="option-link">About | Bugs | Request Games</a>
        <a href="./save/" class="option-link">Save manager</a>
        <a href="https://discord.gg/pWjfQ4Sz5c" class="option-link">Discord Server</a>
      </div>
    </div>

    <div class="custom-slide-menu" id="customSlideMenu" style="transform:translateX(-100%)">
      <div class="custom-options" style="padding:20px">
        <div class="toggle-option" style="margin-bottom:10px">
          <label for="top20Toggle">Show Top 20</label>
          <input type="checkbox" id="top20Toggle" checked />
        </div>
        <div class="toggle-option" style="margin-bottom:10px">
          <label for="favoritesToggle">Show Favorites</label>
          <input type="checkbox" id="favoritesToggle" />
        </div>
        <div class="slider-option" style="margin-bottom:10px">
          <label
            for="cardSizeSlider"
            style="color:white; display:block; margin-bottom:5px"
          >
            Card Size Adjustment
          </label>
          <input
            type="range"
            id="cardSizeSlider"
            min="-100"
            max="100"
            value="0"
            step="1"
            style="width:100%"
          />
          <div style="text-align:center; color:white; margin-top:5px">
            Value: <span id="cardSizeValue">0</span>
          </div>
        </div>
      </div>
    </div>

    <div class="overlay" id="favoritesOverlay"></div>
    <div class="popup-container" id="favoritesPopupContainer">
      <div class="popup" id="favoritesPopup">
        <p>You need to sign in to view your favorites.</p>
        <button id="favoritesOkButton">OK</button>
      </div>
    </div>

    <script>
      const altLinksEl = document.getElementById("alternate-links-container");
      const altLinksKeyEl = document.getElementById("alternate-links-key");
      const altLinks = [
        "mastersite.org",
        "65a.org",
        "fundle.org",
        "gametree.net",
        "hateroll.com",
        "strongdogunblocked.github.io",
        "weakcatxp.github.io",
        "gametreexp.github.io",
        "mathcordxp.github.io",
        "strongdogxp.github.io",
        "jman1593.github.io",
        "strongdog-1.vercel.app",
        "mathcord.com",
        "strongdog.com",
      ];
    
      function pingSite(domain) {
        return new Promise((resolve) => {
          const img = new Image();
          img.src = "https://" + domain + "/img/1v1.webp?" + new Date().getTime();
          img.style.position = "absolute";
          img.style.left = "-9999px";
          img.style.width = "1px";
          img.style.height = "1px";
          img.style.opacity = "0";
          document.body.appendChild(img);
          img.onload = () => {
            resolve(true);
            document.body.removeChild(img);
          };
          img.onerror = () => {
            resolve(false);
            document.body.removeChild(img);
          };
          setTimeout(() => {
            resolve(false);
            if (document.body.contains(img)) document.body.removeChild(img);
          }, 5000);
        });
      }
    
      async function checkSiteStatus(domain, statusDot, maxRetries = 2) {
        let retries = 0;
        let isUnblocked = await pingSite(domain);
    
        while (!isUnblocked && retries < maxRetries) {
          retries++;
          console.log(`Retrying ${domain} (Attempt ${retries + 1}/${maxRetries + 1})`);
          isUnblocked = await pingSite(domain);
        }
    
        statusDot.style.backgroundColor = isUnblocked ? "#28a745" : "#dc3545";
      }
    
      altLinks.forEach((link) => {
        const a = document.createElement("a");
        a.href = "https://" + link;
        a.target = "_blank";
        a.classList.add("alternate-link");
        a.style.display = "flex";
        a.style.alignItems = "center";
        a.style.justifyContent = "space-between";
        a.style.padding = "10px 15px";
        a.style.textDecoration = "none";
        a.style.color = "#007bff";
        a.style.backgroundColor = "#3e3e3e";
        a.style.borderRadius = "10px";
        a.style.transition = "all 0.3s ease";
        a.style.boxShadow = "0 4px 15px rgba(0, 0, 0, 0.3)";
        a.onmouseover = () => {
          a.style.color = "#0056b3";
          a.style.backgroundColor = "#4e4e4e";
          a.style.boxShadow = "0 6px 20px rgba(0, 0, 0, 0.5)";
        };
        a.onmouseout = () => {
          a.style.color = "#007bff";
          a.style.backgroundColor = "#3e3e3e";
          a.style.boxShadow = "0 4px 15px rgba(0, 0, 0, 0.3)";
        };
    
        const linkText = document.createElement("span");
        linkText.textContent = link;
        linkText.style.flexGrow = "1";
        linkText.style.fontSize = "1.1rem";
        linkText.style.fontWeight = "600";
    
        const statusDot = document.createElement("span");
        statusDot.classList.add("status-dot");
        statusDot.style.width = "12px";
        statusDot.style.height = "12px";
        statusDot.style.borderRadius = "50%";
        statusDot.style.backgroundColor = "black";
        statusDot.style.display = "inline-block";
        statusDot.style.marginLeft = "10px";
    
        a.appendChild(linkText);
        a.appendChild(statusDot);
        altLinksEl.appendChild(a);
    
        checkSiteStatus(link, statusDot);
      });
    
      altLinksKeyEl.style.textAlign = "center";
      altLinksKeyEl.style.marginTop = "15px";
      altLinksKeyEl.style.fontSize = "14px";
      altLinksKeyEl.style.color = "#aaa";
      altLinksKeyEl.innerHTML = `
        <span style="margin-right: 15px;">
          <span class="status-dot" style="background-color:#28a745;"></span> Unblocked
        </span>
        <span style="margin-right: 15px;">
          <span class="status-dot" style="background-color:#dc3545;"></span> Blocked
        </span>
        <span>
          <span class="status-dot" style="background-color:black;"></span> Loading
        </span>
      `;
    </script>

    <script type="module">
      import games from "./cards-data.js";
      import { targetUrl } from "./appscript.js";

      function getTierAndProgressFromXP(xp) {
        const baseXPNeeded = 50;
        const increasePerTier = 200;
        const exponentialMultiplier = 1.2;
        const levelsPerTier = 5;
        const capTier = 10;

        let level = 1,
          tier = 1,
          xpNeeded = baseXPNeeded;
        while (xp >= xpNeeded) {
          xp -= xpNeeded;
          if (tier < capTier) {
            if (level % levelsPerTier === 0) {
              tier++;
              xpNeeded = Math.round(xpNeeded * exponentialMultiplier);
            }
          } else {
            if (level % levelsPerTier === 0) {
              xpNeeded += increasePerTier;
            }
          }
          level++;
        }
        return { level, tier, currentXP: xp, xpNeededForNext: xpNeeded };
      }

      const numTopGames = 20;
      const topGameList = document.getElementById("topGameList");
      for (let i = 0; i < numTopGames; i++) {
        const ghostCard = document.createElement("div");
        ghostCard.classList.add("ghost-card");
        ghostCard.style.animation = `pulse 2s ${i / 15}s infinite`;
        topGameList.appendChild(ghostCard);
      }

      async function fetchTopGames() {
        try {
          const response = await fetch(targetUrl);
          if (!response.ok) throw new Error("Network error: " + response.statusText);
          const data = await response.json();
          if (data && data.content) {
            const parsedData = JSON.parse(data.content);
            console.log("Parsed data:", parsedData);
            displayTopGames(parsedData);
          } else {
            console.error("Invalid data format:", data);
          }
        } catch (err) {
          console.error("Error fetching top games:", err);
        }
      }
      fetchTopGames();

      function displayTopGames(topData) {
        topGameList.innerHTML = "";
        let foundCount = 0;
        let index = 1;
        const displayed = new Set();
        while (foundCount < numTopGames && index < topData.length) {
          const row = topData[index];
          const gameName = row[0];
          const card = findMatchingCard(gameName);
          if (card) {
            if (!displayed.has(gameName)) {
              topGameList.appendChild(card.cloneNode(true));
              displayed.add(gameName);
              foundCount++;
            }
          } else {
            console.warn(`Card for "${gameName}" not found, skipping.`);
          }
          index++;
        }
      }
      function normalizeGameName(name) {
        return name.toLowerCase().replace(/\s+/g, "").replace(/[^a-z0-9]/g, "");
      }
      function findMatchingCard(gameName) {
        const normalized = normalizeGameName(gameName);
        const allCards = document.querySelectorAll("#allGameList .card");
        for (let card of allCards) {
          if (card.getAttribute("data-game-id") === normalized) {
            return card;
          }
        }
        return null;
      }

      function getPageNumberFromURL(url) {
        const regex = /(strongdog|mathcord|stroongdog)(\d*)/;
        const match = url.match(regex);
        if (match) {
          return match[2] === "" ? 1 : parseInt(match[2], 10);
        }
        return 1;
      }
      const siteMapping = window.siteMapping || {};
      function getCurrentSiteKey() {
        const currentURL = window.location.href;
        const keys = Object.keys(siteMapping).sort((a, b) => b.length - a.length);
        for (const k of keys) {
          if (currentURL.includes(k)) return k;
        }
        return null;
      }
      function getAdjustedUrls(href, imgSrc, page) {
        let adjustedHref = href;
        let adjustedImgSrc = `./img/${imgSrc}`;
        const currentSiteKey = getCurrentSiteKey();
        if (currentSiteKey) {
          const currentSitePages = siteMapping[currentSiteKey];
          const pageMap = {};
          let currentPageNumber = getPageNumberFromURL(currentSiteKey);
          pageMap[currentPageNumber] = currentSiteKey;
          if (currentSitePages) {
            currentSitePages.forEach((u) => {
              const pNum = getPageNumberFromURL(u);
              pageMap[pNum] = u;
            });
          }
          if (page !== undefined && page !== currentPageNumber) {
            let newBase = pageMap[page];
            if (!newBase) newBase = window.location.origin + `/strongdog${page}`;
            adjustedHref = `${newBase}/${href.replace(/^\.\//, "")}`;
            adjustedImgSrc = `${newBase}/img/${imgSrc.replace(/^\.\//, "")}`;
          }
        } else {
          if (page !== undefined && page > 1) {
            const origin = window.location.origin;
            const newBase = `${origin}/strongdog${page}`;
            adjustedHref = `${newBase}/${href.replace(/^\.\//, "")}`;
            adjustedImgSrc = `${newBase}/img/${imgSrc.replace(/^\.\//, "")}`;
          }
        }
        return { adjustedHref, adjustedImgSrc };
      }
      function getCardHTML(game) {
        const { href, imgSrc, name, page, id } = game;
        const { adjustedHref, adjustedImgSrc } = getAdjustedUrls(href, imgSrc, page);
        const gameLink = `./play/?id=${id}`;
        const normalized = normalizeGameName(name);
        return `
          <a href="${gameLink}" class="card" data-game-id="${normalized}" data-page="${page}">
            <img src="${adjustedImgSrc}" alt="${name}">
            <figcaption>${name}</figcaption>
          </a>
        `;
      }
      const allGameListElement = document.getElementById("allGameList");
      allGameListElement.innerHTML = games.map((g) => getCardHTML(g)).join("");

      const searchInput = document.getElementById("searchInput");
      const searchResults = document.getElementById("searchResults");
      function updateSearchResults() {
        const text = searchInput.value.toLowerCase();
        const filtered = games.filter((g) => g.name.toLowerCase().includes(text)).slice(0, 7);
        searchResults.innerHTML = "";
        if (filtered.length === 0) {
          searchResults.style.display = "none";
          return;
        }
        filtered.forEach((game) => {
          const { id, imgSrc, name, page } = game;
          const { adjustedImgSrc } = getAdjustedUrls(game.href, imgSrc, page);
          const linkEl = document.createElement("a");
          linkEl.href = `./play/?id=${id}`;
          linkEl.innerHTML = `<img src="${adjustedImgSrc}" alt="${name}"><span>${name}</span>`;
          searchResults.appendChild(linkEl);
        });
        searchResults.style.display = "block";
      }
      if (searchInput && searchResults) {
        searchInput.addEventListener("focus", updateSearchResults);
        searchInput.addEventListener("input", updateSearchResults);
        document.addEventListener("click", (ev) => {
          if (!searchInput.contains(ev.target) && !searchResults.contains(ev.target)) {
            searchResults.style.display = "none";
          }
        });
      }

      const menuIcon = document.getElementById("menuIcon");
      const slideMenu = document.getElementById("slideMenu");
      const categories = slideMenu.querySelector(".categories");
      menuIcon.addEventListener("click", (ev) => {
        ev.stopPropagation();
        slideMenu.style.transform =
          slideMenu.style.transform === "translateX(0%)" ? "translateX(-100%)" : "translateX(0%)";
      });
      window.addEventListener("click", (ev) => {
        if (ev.target !== menuIcon && !slideMenu.contains(ev.target)) {
          slideMenu.style.transform = "translateX(-100%)";
        }
      });

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          const userId = user.uid;
          const userDetailsContainer = document.createElement("div");
          userDetailsContainer.className = "user-details-container";

          const profileTop = document.createElement("div");
          profileTop.className = "profile-top-container";

          const picContainer = document.createElement("div");
          picContainer.className = "profile-picture-container";
          const picEl = document.createElement("img");
          picEl.className = "profile-picture";
          picEl.src = user.photoURL || "img/default-avatar.png";
          picContainer.appendChild(picEl);

          const usernameDiv = document.createElement("div");
          usernameDiv.className = "username-container";
          const usernameText = document.createElement("p");
          usernameText.className = "username-text";
          usernameText.textContent = "Loading...";
          usernameDiv.appendChild(usernameText);

          profileTop.appendChild(picContainer);
          profileTop.appendChild(usernameDiv);
          userDetailsContainer.appendChild(profileTop);

          try {
            const docRef = db.collection("usernames").doc(userId);
            const docSnap = await docRef.get();
            if (docSnap.exists) {
              usernameText.textContent =
                docSnap.data().username || user.displayName || "Username";
            } else {
              usernameText.textContent = user.displayName || "Username";
            }
          } catch (err) {
            console.error("Error reading username doc:", err);
            usernameText.textContent = user.displayName || "Username";
          }

          let totalXP = 0;
          try {
            const xpSnap = await rtdb.ref(`/users/${userId}/xp`).once("value");
            if (xpSnap.exists()) {
              totalXP = xpSnap.val();
            }
          } catch (err) {
            console.error("Error reading XP from Realtime Database:", err);
          }

          const { level, currentXP, xpNeededForNext } = getTierAndProgressFromXP(totalXP);

          const xpContainer = document.createElement("div");
          xpContainer.className = "xp-container";

          const xpLevelText = document.createElement("div");
          xpLevelText.className = "xp-level-text";
          xpLevelText.textContent = `Level ${level}`;

          const xpBar = document.createElement("div");
          xpBar.className = "xp-bar";

          const xpBarFill = document.createElement("div");
          xpBarFill.className = "xp-bar-fill";
          xpBarFill.style.width = `${(currentXP / xpNeededForNext) * 100}%`;

          const xpBarText = document.createElement("div");
          xpBarText.className = "xp-bar-text";
          xpBarText.textContent = `${currentXP}/${xpNeededForNext}`;

          xpBar.appendChild(xpBarFill);
          xpBar.appendChild(xpBarText);
          xpContainer.appendChild(xpLevelText);
          xpContainer.appendChild(xpBar);

          userDetailsContainer.appendChild(xpContainer);

          picContainer.addEventListener("click", () => {
            window.location.href = "settings.html";
          });

          slideMenu.insertBefore(userDetailsContainer, categories);

          const logoutLink = document.createElement("a");
          logoutLink.href = "#";
          logoutLink.className = "option-link";
          logoutLink.textContent = "Log Out";
          logoutLink.style.backgroundColor = "#dc3545";
          logoutLink.style.color = "white";
          logoutLink.addEventListener("click", (e) => {
            e.preventDefault();
            auth.signOut().then(() => window.location.reload());
          });
          const favoritesLink = categories.querySelector('a[href="favs.html"]');
          categories.insertBefore(logoutLink, favoritesLink);

          db.collection("access")
            .doc(userId)
            .get()
            .then((accDoc) => {
              if (accDoc.exists && accDoc.data().tester === true) {
                const testGamesLink = document.createElement("a");
                testGamesLink.href = "test.html";
                testGamesLink.className = "option-link";
                testGamesLink.textContent = "Test Games";
                testGamesLink.style.backgroundColor = "#28a745";
                testGamesLink.style.color = "white";
                testGamesLink.style.marginTop = "10px";
                categories.insertBefore(testGamesLink, favoritesLink);
              }
            })
            .catch((err) => console.error("Error checking 'access' doc:", err));
        } else {
          const userDetailsContainer = document.createElement("div");
          userDetailsContainer.className = "user-details-container";
          userDetailsContainer.style.display = "flex";
          userDetailsContainer.style.flexDirection = "column";
          userDetailsContainer.style.alignItems = "center";
          userDetailsContainer.style.paddingBlock = "20px";

          const notLoggedInContainer = document.createElement("div");
          notLoggedInContainer.className = "username-container";
          const notLoggedInText = document.createElement("p");
          notLoggedInText.className = "username-text";
          notLoggedInText.textContent = "Not logged in";
          notLoggedInContainer.appendChild(notLoggedInText);

          const loginButton = document.createElement("button");
          loginButton.textContent = "Log In";
          loginButton.style.backgroundColor = "#007bff";
          loginButton.style.color = "white";
          loginButton.style.border = "none";
          loginButton.style.padding = "10px 20px";
          loginButton.style.fontSize = "16px";
          loginButton.style.borderRadius = "5px";
          loginButton.style.cursor = "pointer";
          loginButton.style.marginTop = "5px";
          loginButton.addEventListener("click", () => {
            window.location.href = "login.html";
          });

          userDetailsContainer.appendChild(notLoggedInContainer);
          userDetailsContainer.appendChild(loginButton);

          slideMenu.insertBefore(userDetailsContainer, categories);
        }

        const randomGameLink = categories.querySelector("#randomGame");
        randomGameLink?.addEventListener("click", (ev) => {
          ev.preventDefault();
          if (games.length > 0) {
            const idx = Math.floor(Math.random() * games.length);
            window.location.href = `./play/?id=${games[idx].id}`;
          }
        });

        const blockLanschoolLink = categories.querySelector("#blockLanschool");
        blockLanschoolLink?.addEventListener("click", (ev) => {
          ev.preventDefault();
          const url = window.location.href;
          const newTab = window.open();
          if (!newTab) {
            console.warn("Popup blocked—please allow popups!");
            return;
          }
          newTab.document.write(`
            <html>
              <body style="margin:0; height:100vh;">
                <iframe src="${url}" style="border:none; width:100%; height:100%"></iframe>
              </body>
            </html>
          `);
          newTab.document.close();
        });
      });

      const editAllButton = document.getElementById("editAllButton");
      const customSlideMenu = document.getElementById("customSlideMenu");
      editAllButton.addEventListener("click", (ev) => {
        ev.stopPropagation();
        slideMenu.style.transform = "translateX(-100%)";
        customSlideMenu.style.transform =
          customSlideMenu.style.transform === "translateX(0%)"
            ? "translateX(-100%)"
            : "translateX(0%)";
      });
      window.addEventListener("click", (ev) => {
        if (
          ev.target !== editAllButton &&
          !customSlideMenu.contains(ev.target) &&
          ev.target.id !== "editAllButton"
        ) {
          customSlideMenu.style.transform = "translateX(-100%)";
        }
      });

      function setCookie(name, val, days) {
        const d = new Date();
        d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
        document.cookie = `${name}=${val};expires=${d.toUTCString()};path=/`;
      }
      function getCookie(name) {
        const all = `; ${document.cookie}`;
        const parts = all.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";")[0];
        return "";
      }

      const top20Toggle = document.getElementById("top20Toggle");
      const topGameHeader = document.getElementById("topGameHeader");
      let top20Disabled = getCookie("top20Disabled") === "true";
      top20Toggle.checked = !top20Disabled;
      if (top20Disabled) {
        topGameList.style.display = "none";
        topGameHeader.style.display = "none";
      }
      top20Toggle.addEventListener("change", () => {
        if (top20Toggle.checked) {
          topGameList.style.display = "flex";
          topGameHeader.style.display = "block";
          setCookie("top20Disabled", "false", 365);
        } else {
          topGameList.style.display = "none";
          topGameHeader.style.display = "none";
          setCookie("top20Disabled", "true", 365);
        }
      });

      const favoritesToggle = document.getElementById("favoritesToggle");
      const favoritesHeader = document.getElementById("favoritesHeader");
      const favoritesGameList = document.getElementById("favoritesGameList");
      let favCookie = getCookie("favoritesDisabled");
      if (favCookie === "") favCookie = "true";
      const favoritesDisabled = favCookie === "true";
      favoritesToggle.checked = !favoritesDisabled;
      if (favoritesDisabled) {
        favoritesHeader.style.display = "none";
        favoritesGameList.style.display = "none";
      } else {
        favoritesHeader.style.display = "block";
        favoritesGameList.style.display = "flex";
      }
      favoritesToggle.addEventListener("change", () => {
        if (favoritesToggle.checked) {
          favoritesHeader.style.display = "block";
          favoritesGameList.style.display = "flex";
          setCookie("favoritesDisabled", "false", 365);
          loadFavorites();
        } else {
          favoritesHeader.style.display = "none";
          favoritesGameList.style.display = "none";
          setCookie("favoritesDisabled", "true", 365);
        }
      });

      function loadFavorites() {
        const placeholders = 10;
        favoritesGameList.innerHTML = "";
        for (let i = 0; i < placeholders; i++) {
          const ghost = document.createElement("div");
          ghost.classList.add("ghost-card");
          ghost.style.animation = `pulse 2s ${i / 15}s infinite`;
          favoritesGameList.appendChild(ghost);
        }
        auth.onAuthStateChanged((user) => {
          if (user) {
            fetchFavorites(user.uid);
          } else {
            showFavoritesPopup();
            favoritesGameList.innerHTML = '<p class="no-favorites">No favorites yet!</p>';
          }
        });
      }
      async function fetchFavorites(userId) {
        try {
          const favDoc = await db.collection("favs").doc(userId).get();
          if (favDoc.exists) {
            const favData = favDoc.data();
            console.log("Favorites data retrieved:", favData);
            displayFavorites(favData);
          } else {
            favoritesGameList.innerHTML = '<p class="no-favorites">No favorites yet!</p>';
          }
        } catch (err) {
          console.error("Error fetching favorites:", err);
          favoritesGameList.innerHTML = '<p class="no-favorites">Error loading favorites.</p>';
        }
      }
      function displayFavorites(favs) {
        favoritesGameList.innerHTML = "";
        let hasFavorites = false;
        Object.keys(favs).forEach((gameId) => {
          if (favs[gameId]) {
            const g = games.find((gm) => parseInt(gm.id, 10) === parseInt(gameId, 10));
            if (g) {
              hasFavorites = true;
              favoritesGameList.innerHTML += getCardHTML(g);
            } else {
              console.warn(`Game with ID ${gameId} not found in games data.`);
            }
          }
        });
        if (!hasFavorites) {
          favoritesGameList.innerHTML = '<p class="no-favorites">No favorites yet!</p>';
        }
      }
      function showFavoritesPopup() {
        document.getElementById("favoritesPopupContainer").classList.add("active");
        document.getElementById("favoritesOverlay").style.display = "block";
      }
      function hideFavoritesPopup() {
        document.getElementById("favoritesPopupContainer").classList.remove("active");
        document.getElementById("favoritesOverlay").style.display = "none";
      }
      document.getElementById("favoritesOkButton").addEventListener("click", hideFavoritesPopup);

      if (favoritesToggle.checked) {
        loadFavorites();
      }

      const cardSizeSlider = document.getElementById("cardSizeSlider");
      const cardSizeValue = document.getElementById("cardSizeValue");

      function updateCardSizes() {
        const val = parseInt(cardSizeSlider.value, 10);
        cardSizeValue.textContent = val;
        const newSize = 120 + val;
        const newGap = Math.max(10 + val / 4, 5);
        const newRadius = val < 0 ? Math.max(15 + val * 0.13, 2) : 15;

        document.querySelectorAll(".card, .ghost-card").forEach((c) => {
          c.style.width = newSize + "px";
          c.style.height = newSize + "px";
          c.style.borderRadius = newRadius + "px";
        });
        document.querySelectorAll(".games-grid").forEach((grid) => {
          grid.style.gap = newGap + "px";
        });
        setCookie("cardSize", val, 365);
      }

      cardSizeSlider.addEventListener("input", updateCardSizes);
      const savedSize = getCookie("cardSize");
      if (savedSize !== "") {
        cardSizeSlider.value = savedSize;
        updateCardSizes();
      }

      document.addEventListener("DOMContentLoaded", () => {
        const page1Link = document.getElementById("page1-link");
        const page2Link = document.getElementById("page2-link");
        if (!page1Link || !page2Link) return;
        const hostname = window.location.hostname;
        const linkMap = {
          "jman1593.github.io": { page1: "/#", page2: "/strongdog2/index.html" },
        };
        for (const key in linkMap) {
          if (hostname.includes(key)) {
            page1Link.href = linkMap[key].page1;
            page2Link.href = linkMap[key].page2;
            break;
          }
        }
      });
    </script>
  </body>
</html>